<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>XRBitcoin · XRB on XRPL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Open Graph -->
  <meta property="og:title" content="XRBitcoin · XRB on XRPL">
  <meta property="og:description" content="Trade XRBitcoin on the XRP Ledger. Connect your wallet and explore the XRB/XRP decentralized exchange.">
  <meta property="og:image" content="https://xrbitcoincash.com/xrbc-nft.png"><!-- TEMP logo; see note -->
  <meta property="og:url" content="https://xrbitcoincash.com/XRBitcoin/">
  <meta property="og:type" content="website">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="XRBitcoin · XRB on XRPL">
  <meta name="twitter:description" content="Decentralized XRB/XRP trading on the XRP Ledger.">
  <meta name="twitter:image" content="https://xrbitcoincash.com/xrbc-nft.png"><!-- TEMP logo; see note -->

  <!-- Favicon / icons (TEMP logo; see note) -->
  <link rel="icon" href="/xrbc-nft.png" type="image/png">
  <link rel="shortcut icon" href="/xrbc-nft.png" type="image/png">
  <link rel="apple-touch-icon" href="/xrbc-nft.png">
  <meta name="msapplication-TileImage" content="/xrbc-nft.png">

  <style>
   :root{
    --bg:#0b0f14;--panel:#121821;--panel-2:#141b25;--text:#e7edf5;--muted:#9fb0c5;
    --accent:#60a5fa;--accent-2:#22d3ee;--warn:#f59e0b;--err:#ef4444;--ok:#22c55e;
    --border:#1f2937;--ring:#1d4ed8;--shadow:0 10px 30px rgba(0,0,0,.35)
   }
   *{box-sizing:border-box;margin:0;padding:0}
   html,body{height:100%;background:var(--bg);color:var(--text);
     font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow-x:hidden}
   .container{max-width:900px;margin:0 auto;padding:20px 16px;position:relative;z-index:5}
   .row-flex{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start}
   .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);
     border-radius:14px;padding:16px;box-shadow:var(--shadow);flex:1;min-width:260px}
   .card.glow{border-color:var(--accent-2);box-shadow:0 0 20px rgba(34,211,238,.3)}
   .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#0e1520,#0c131c);
     color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:var(--shadow);
     transition:transform .06s ease,border-color .2s ease,box-shadow .2s ease;min-width:120px;text-align:center}
   .btn:hover{transform:translateY(-1px);border-color:#2a3a51}
   .btn:active{transform:translateY(0)}
   .btn[disabled]{opacity:.6;cursor:not-allowed}
   .btn-primary{background:linear-gradient(180deg,rgba(37,99,235,.25),rgba(37,99,235,.15));border-color:rgba(37,99,235,.45)}
   .btn-secondary{background:linear-gradient(180deg,rgba(34,211,238,.22),rgba(34,211,238,.12));border-color:rgba(34,211,238,.45)}
   .status-text{font-size:13px;color:var(--muted);margin-left:12px}
   .status-text.ok{color:var(--ok)} .status-text.err{color:var(--err)}
   pre{background:#0c131c;border:1px solid #1c2736;border-radius:10px;padding:8px;max-height:200px;overflow:auto;font-size:12px;color:#a3e4ff}
   .table{width:100%;border-collapse:collapse;font-size:14px}
   .table th,.table td{padding:8px 10px;border-bottom:1px solid #1a2433}
   .table thead th{background:#0f1722;color:#cfe2ff}
   .brand{display:flex;align-items:center;justify-content:center;gap:12px;text-align:center;width:100%}
   .brand img{max-height:40px}
   .trade-card{display:grid;gap:12px;text-align:left}
   .tabset{display:grid;grid-template-columns:1fr 1fr;gap:8px}
   .tab{padding:10px 12px;border:1px solid var(--border);background:linear-gradient(180deg,#0e1520,#0c131c);
     border-radius:10px;font-weight:700;cursor:pointer;text-align:center}
   .tab.buy{color:#22c55e}.tab.sell{color:#ef4444}
   .tab.buy.active{border-color:rgba(34,197,94,.5);box-shadow:0 0 0 2px rgba(34,197,94,.15) inset}
   .tab.sell.active{border-color:rgba(239,68,68,.5);box-shadow:0 0 0 2px rgba(239,68,68,.15) inset}
   .field{display:grid;gap:6px}.field label{font-size:13px;color:var(--muted)}
   .field input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0c131c;color:var(--text)}
   .field .row{display:grid;grid-template-columns:1fr auto;gap:8px}
   .inline-hint{font-size:12px;color:var(--muted)}
   .total-line{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px dashed var(--border);
     border-radius:10px;background:linear-gradient(180deg,#0b1119,#0a0f15)}
   .amount-row{display:flex;align-items:center;gap:6px}
   .amount-row img{max-height:22px}
   .button-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
   @media (max-width:600px){.row-flex{flex-direction:column}.btn{width:100%}.button-row{grid-template-columns:1fr}}
   @keyframes flashText{from{opacity:1}to{opacity:.3}}
   .status-text.connecting{animation:flashText 1.6s infinite alternate;color:#00e5ff!important;font-weight:700}
   .refresh-indicator{display:flex;align-items:center;gap:8px;font-size:12px;color:#60a5fa}
   .clock{width:20px;height:20px;border:2px solid #60a5fa;border-radius:50%;position:relative;animation:spinHand 10s linear infinite}
   .clock::after{content:"";position:absolute;top:2px;left:9px;width:2px;height:8px;background:#60a5fa;transform-origin:bottom center}
   @keyframes spinHand{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  </style>
</head>

<body>
<header class="site-header">
  <div class="brand" style="flex-direction: column; justify-content: center; text-align: center;">
    <img src="/xrbc-nft.png" alt="XRBitcoin logo"><!-- TEMP logo; see note -->
    <h1>XRBitcoin</h1>
    <a href="https://xrbitcoincash.com/XRBitcoin/" class="btn btn-secondary" style="margin-top: 12px;">Home</a>
  </div>
</header>

<div class="container" style="max-width:800px;margin:0 auto;padding:20px;text-align:center;">

  <!-- Header -->
  <h1 style="margin-bottom:24px;">XRBitcoin · XRB/XRP Trading & Ledger Portal</h1>

  <!-- Wallet Section -->
  <div class="card glow" style="margin-bottom:24px;">
    <h2 style="margin-top:0;">Wallet</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:16px 0;">
      <button id="connectWalletBtn" class="btn btn-primary glow-btn">Connect Wallet</button>
      <button id="disconnectWalletBtn" class="btn btn-secondary glow-btn" disabled>Disconnect</button>
    </div>
    <p id="walletStatus" class="status-text">Status: Not connected</p>
  </div>

  <button id="setTrustlineBtn" class="btn btn-primary">Set XRBitcoin Trustline</button>
  <div id="trustlineMsg" class="status-text" style="margin-bottom:20px;">—</div>

  <!-- Ledger Info -->
  <div class="card" style="margin-bottom:24px;">
    <h2 style="margin-top:0;">Ledger Info</h2>
    <button id="fetchLedgerBtn" class="btn glow-btn" style="margin-bottom:12px;">Fetch Ledger Info</button>
    <pre id="ledgerOutput" style="text-align:left;">—</pre>
  </div>

  <!-- Trade -->
  <div class="card" style="margin-bottom:24px;">
    <h2 style="margin-top:0;">Trade XRBitcoin ↔ XRP</h2>

    <div class="trade-card" id="tradeCard">
      <div class="tabset">
        <button id="buyTab" class="tab buy active" type="button">Buy XRBitcoin</button>
        <button id="sellTab" class="tab sell" type="button">Sell XRBitcoin</button>
      </div>

      <div class="field">
        <label for="amount">Amount (XRBitcoin)</label>
        <div class="amount-row">
          <img src="/xrbc-nft.png" alt="XRBitcoin logo"><!-- TEMP logo; see note -->
          <input id="amount" type="number" step="0.000001" inputmode="decimal" placeholder="0.000000">
        </div>
        <div class="inline-hint">How many XRBitcoin you want to <span id="actionWord">buy</span>.</div>
      </div>

      <div class="field" id="priceField">
        <label for="price">Price (XRP per XRBitcoin)</label>
        <div class="row">
          <input id="price" type="number" step="0.000001" inputmode="decimal" placeholder="e.g., 0.500000">
          <button class="btn btn-secondary" id="suggestPriceBtn" type="button">Best Price</button>
        </div>
        <div class="inline-hint">Limit price. Use <em>Market Order</em> to execute at best available price.</div>
      </div>

      <div class="total-line">
        <span>Total</span>
        <strong id="totalXrp">0.000000 XRP</strong>
      </div>

      <div class="button-row">
        <button id="placeOfferBtn" class="btn btn-primary" type="button">Place Limit Order</button>
        <div class="refresh-indicator">
          <div class="clock"></div>
          <span class="refresh-text">Auto-refreshes every 10s</span>
        </div>
      </div>

      <p id="tradeMsg" class="status-text">—</p>
      <select id="side" style="display:none">
        <option value="buy" selected>Buy</option>
        <option value="sell">Sell</option>
      </select>
    </div>
  </div>

  <!-- Order Book -->
  <div class="card" style="margin-bottom:24px;">
    <h2 style="margin-top:0;">XRB/XRP Order Book</h2>
    <button id="fetchPriceBtn" class="btn glow-btn" style="margin-bottom:12px;">Get Order Book</button>
    <p id="priceOutput">—</p>
  </div>

  <!-- AMM Pool Info -->
  <div class="card" style="margin-bottom:24px;">
    <h2 style="margin-top:0;">XRB/XRP AMM Pool</h2>
    <div id="ammPoolOutput">Loading pool info…</div>
  </div>
</div>

<!-- Config -->
<script type="application/json" id="app-config">
{
  "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
  "proxyUrl": "https://xrbitcoincash-github-io.onrender.com"
}
</script>

<!-- Libraries -->
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script>
<!-- JS START -->
<script>
/* =========================================================================
   XRBitcoin — Production JS (drop-in)
   - Uses existing <script id="app-config"> for PROXY_URL
   - No placeholders; issuer/currency fixed to XRBitcoin project
   - Safe to include on any page; auto-wires if matching DOM IDs exist
   ======================================================================= */

// === Config ===
const __cfgEl = document.getElementById("app-config");
if (!__cfgEl) throw new Error("Missing #app-config JSON <script> in DOM");
const __cfg = JSON.parse(__cfgEl.textContent);
const PROXY_URL = __cfg.proxyUrl;

// === XRBitcoin (XRB) constants ===
const XRB = {
  currency: "5852626974636F696E0000000000000000000000", // XRBitcoin hex code
  issuer:   "rGQaHbQHCsTLQtboQPwUBasXjLvk8uDbpT"        // XRBitcoin issuer
};
const XRP_TO_DROPS = 1_000_000;

// ---------- Utilities ----------
const toDrops   = (xrp)  => Math.round(Number(xrp) * XRP_TO_DROPS);
const fromDrops = (drp)  => Number(drp) / XRP_TO_DROPS;
const fmtXRP    = (n)    => Number(n).toLocaleString(undefined, { maximumFractionDigits: 6 });
const fmtIOU    = (n)    => Number(n).toLocaleString(undefined, { maximumFractionDigits: 6 });
const sleep     = (ms)   => new Promise(r => setTimeout(r, ms));

// ---------- Proxy bridge ----------
async function xrplRequest(payload) {
  const res = await fetch(PROXY_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Proxy error ${res.status}: ${txt.slice(0, 200)}`);
  }
  const data = await res.json();
  if (data.error) throw new Error("XRPL error: " + JSON.stringify(data.error));
  return data;
}

// ---------- Core XRPL calls ----------
async function getLedgerStatus() {
  const resp = await xrplRequest({ id: 1, command: "server_state" });
  const s = resp?.result?.state;
  return {
    server:  s?.pubkey_node || "unknown",
    load:    s?.load_base,
    ledger:  s?.validated_ledger?.seq,
    closeMs: s?.validated_ledger?.close_time_resolution,
    peers:   s?.peers
  };
}

/**
 * Convert offer quality to a human-readable price.
 * We compute two forms for clarity:
 *   - price_xrp_per_xrb: how many XRP per 1 XRB
 *   - price_xrb_per_xrp: how many XRB per 1 XRP
 * Works for both XRP/IOU and IOU/XRP sides using delivered 'quality'
 * and normalizing drops <-> XRP when needed.
 */
function qualityToPrices(offer) {
  // quality = taker_pays / taker_gets (in their base units)
  // If either side is XRP it’s in drops; IOUs use decimal string 'value'.
  let paysIsXRP = typeof offer.taker_pays === "string"; // drops if string
  let getsIsXRP = typeof offer.taker_gets === "string";

  // Determine base units for 1 XRB
  // We want XRP per XRB, so set:
  //   if taker_gets is XRB: 1 XRB -> required XRP from 'quality'
  //   else if taker_pays is XRB: invert.
  const q = Number(offer.quality);

  // Helper to normalize (amount object or drops string) to numeric
  const amountToNum = (amt) => {
    if (typeof amt === "string") return fromDrops(amt);
    return Number(amt.value);
  };

  // We can't directly scale from quality alone without direction hint.
  // We'll compute effective unit prices from the actual fields to be robust.
  const pays = amountToNum(offer.taker_pays);
  const gets = amountToNum(offer.taker_gets);

  // pays/gets == quality in native units; both now numeric XRP or XRB.
  // Price (XRP per XRB) = (pays in XRP) / (gets in XRB) when pays is XRP and gets is XRB
  // Otherwise, invert accordingly.
  let price_xrp_per_xrb;
  if (paysIsXRP && !getsIsXRP) {
    price_xrp_per_xrb = pays / gets;           // XRP per 1 XRB
  } else if (!paysIsXRP && getsIsXRP) {
    price_xrp_per_xrb = gets / pays;           // invert
  } else {
    // IOU/IOU or XRP/XRP (shouldn't happen in our pair). Fallback to q using drops heuristics:
    price_xrp_per_xrb = paysIsXRP ? q / 1 : 1 / q;
  }

  const price_xrb_per_xrp = 1 / price_xrp_per_xrb;
  return { price_xrp_per_xrb, price_xrb_per_xrp };
}

/**
 * Fetch best ask (sell XRB for XRP) and best bid (buy XRB with XRP) from book_offers.
 * Returns:
 * {
 *   ask: { price_xrp_per_xrb, qty_xrb_available },
 *   bid: { price_xrp_per_xrb, qty_xrb_available }
 * }
 */
async function fetchBestPrices() {
  // --- Best ASK: creators selling XRB, taker pays XRP, gets XRB
  const askBook = await xrplRequest({
    id: "ask",
    command: "book_offers",
    taker: "rrrrrrrrrrrrrrrrrrrrrhoLvTp", // canonical placeholder taker; XRPL allows any
    taker_gets: { currency: XRB.currency, issuer: XRB.issuer }, // taker receives XRB
    taker_pays: "1000000", // XRP in drops; value not used for filtering, just type
    limit: 10
  });

  // --- Best BID: creators buying XRB, taker pays XRB, gets XRP
  const bidBook = await xrplRequest({
    id: "bid",
    command: "book_offers",
    taker: "rrrrrrrrrrrrrrrrrrrrrhoLvTp",
    taker_gets: "1000000", // taker receives XRP (drops)
    taker_pays: { currency: XRB.currency, issuer: XRB.issuer }, // taker pays XRB
    limit: 10
  });

  const bestAskOffer = askBook?.result?.offers?.[0];
  const bestBidOffer = bidBook?.result?.offers?.[0];

  const ask = bestAskOffer
    ? (() => {
        const { price_xrp_per_xrb } = qualityToPrices(bestAskOffer);
        const qty = Number(bestAskOffer?.taker_gets?.value || 0);
        return { price_xrp_per_xrb, qty_xrb_available: qty };
      })()
    : null;

  const bid = bestBidOffer
    ? (() => {
        const { price_xrp_per_xrb } = qualityToPrices(bestBidOffer);
        const qty = Number(bestBidOffer?.taker_pays?.value || 0);
        return { price_xrp_per_xrb, qty_xrb_available: qty };
      })()
    : null;

  return { ask, bid };
}

async function fetchAMMInfo() {
  // XRPL AMM info for XRB/XRP if pool exists
  const resp = await xrplRequest({
    id: "amm",
    command: "amm_info",
    asset: { currency: XRB.currency, issuer: XRB.issuer },
    asset2: { currency: "XRP" }
  }).catch(() => null);

  if (!resp?.result?.amm) return null;

  const amm = resp.result.amm;
  // Normalize balances
  const xrbBal = Number(amm.asset?.value ?? 0);
  const xrpBal = Number(amm.asset2?.value ?? 0);
  const lp     = Number(amm.lp_token?.value ?? 0);

  // Constant product fair price (no fee/slip): XRP per XRB ≈ xrpBal / xrbBal
  const mid = xrbBal > 0 ? (xrpBal / xrbBal) : null;

  return {
    exists: true,
    xrb_balance: xrbBal,
    xrp_balance: xrpBal,
    lp_supply: lp,
    mid_xrp_per_xrb: mid,
    trading_fee_bps: Number(amm.trading_fee || 0)
  };
}

// ---------- Optional DOM wiring ----------
// If the hosting page includes elements with these IDs, we update them.
async function wireDOM() {
  const els = {
    status:    document.getElementById("xrbtc-status"),
    ledger:    document.getElementById("xrbtc-ledger"),
    bestAsk:   document.getElementById("xrbtc-best-ask"),
    bestBid:   document.getElementById("xrbtc-best-bid"),
    ammMid:    document.getElementById("xrbtc-amm-mid"),
    ammBalXRB: document.getElementById("xrbtc-amm-xrb"),
    ammBalXRP: document.getElementById("xrbtc-amm-xrp")
  };

  // If page has none of these, skip quietly.
  const present = Object.values(els).some(Boolean);
  if (!present) return;

  // Rotating status messages (only if #xrbtc-status exists)
  const statusCycle = [
    "Contacting XRPL…",
    "Syncing ledger…",
    "Fetching order books…",
    "Checking AMM…"
  ];
  let ix = 0;
  let cycleTimer = null;

  const setStatus = (msg) => { if (els.status) els.status.textContent = msg; };
  const startCycle = () => {
    if (!els.status) return;
    cycleTimer = setInterval(() => {
      ix = (ix + 1) % statusCycle.length;
      setStatus(statusCycle[ix]);
    }, 1800);
  };
  const stopCycle = () => { if (cycleTimer) clearInterval(cycleTimer); };

  try {
    setStatus(statusCycle[0]);
    startCycle();

    // Ledger
    const st = await getLedgerStatus();
    if (els.ledger) els.ledger.textContent = `#${st.ledger} • peers ${st.peers ?? "?"}`;

    // Books
    const { ask, bid } = await fetchBestPrices();
    if (els.bestAsk) {
      els.bestAsk.textContent = ask
        ? `${fmtXRP(ask.price_xrp_per_xrb)} XRP/XRB • qty ${fmtIOU(ask.qty_xrb_available)}`
        : "—";
    }
    if (els.bestBid) {
      els.bestBid.textContent = bid
        ? `${fmtXRP(bid.price_xrp_per_xrb)} XRP/XRB • qty ${fmtIOU(bid.qty_xrb_available)}`
        : "—";
    }

    // AMM (optional)
    const amm = await fetchAMMInfo();
    if (amm?.exists) {
      if (els.ammMid)    els.ammMid.textContent    = `${fmtXRP(amm.mid_xrp_per_xrb)} XRP/XRB`;
      if (els.ammBalXRB) els.ammBalXRB.textContent = fmtIOU(amm.xrb_balance);
      if (els.ammBalXRP) els.ammBalXRP.textContent = fmtXRP(amm.xrp_balance);
    } else {
      if (els.ammMid)    els.ammMid.textContent    = "No AMM pool";
      if (els.ammBalXRB) els.ammBalXRB.textContent = "—";
      if (els.ammBalXRP) els.ammBalXRP.textContent = "—";
    }

    stopCycle();
    setStatus("Live");
  } catch (err) {
    stopCycle();
    setStatus("Error");
    // Only surface a brief message to users; keep details in console.
    console.error("[XRBitcoin] Fatal:", err);
  }
}

// ---------- Public API (optional consumption by other scripts) ----------
window.XRBitcoin = {
  PROXY_URL,
  XRB,
  utils: { toDrops, fromDrops, fmtXRP, fmtIOU, sleep },
  xrplRequest,
  getLedgerStatus,
  fetchBestPrices,
  fetchAMMInfo,
  wireDOM
};

// Auto-run DOM wiring when ready (safe if IDs aren’t present)
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", () => wireDOM());
} else {
  wireDOM();
}


</script>
</body>
</html>
